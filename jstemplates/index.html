<!doctype html>
<html>
  <head>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!--link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"-->
    <title></title>
</head>
 <body>
    <div>
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
        <style>
            .flexing {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;                
            }
        </style>
        <div class='flexing' id='flexdiv'>
            <img id="myImage" width="640" height="480"></img>
        </div>
        <script>
            var socket = io();
            var myId;
            const myImage = document.getElementById('myImage');
            const flexdiv = document.getElementById('flexdiv');
            var imageCapture;
            var intervalTimer;
        
            const imageConstraints = {
                video: true
            };

            socket.on('connect', () => {
                console.log('Im connected!');
            });

            socket.on('id', (id) => {
                console.log('I got assigned id: ' + id);
                myId = id;
            });
        
            socket.on('blob', (blob, id) => {
                if (id !== myId) {
                    var node = document.getElementById(id);
                    if (node !== null) {
                        node.src = URL.createObjectURL(new Blob([blob], {type: 'application/octet-stream'}));
                    }
                }
            });

            socket.on('client-disconnected', (id) => {
                if (id != myId) {
                    console.log('Client with id ' + id + ' disconnected');
                    var node = document.getElementById(id);
                    flexdiv.removeChild(node);
                }
            });

            socket.on('client-connected', (id) => {
                if (id != myId) {
                    createNewCamera(id);
                    socket.emit('im-here', myId);
                    console.log('Client with id ' + id + ' connected');
                }
            });

            socket.on('im-here', (id) => {
                if (document.getElementById(id) === null) {
                    createNewCamera(id);
                    console.log('Found new peer already here: ' + id);
                }
            });

            function createNewCamera(id) {
                var node = document.createElement("img");
                node.id = id;
                node.width = 640;
                node.height = 480;
                flexdiv.appendChild(node);
            }
                
            function getSS() {
                imageCapture.takePhoto().then(function(blob) {
                    myImage.src = URL.createObjectURL(blob);
                    socket.binary(true).emit('blob', blob, myId);
                })
                .catch((err) => {
                    console.log('takePhoto(): ' + err);
                });
            };
        
            function initStream(constraints) {
                navigator.mediaDevices.getUserMedia(constraints)
                .then((stream) => {
                    imageCapture = new ImageCapture(stream.getVideoTracks()[0]);
                    intervalTimer = setInterval(getSS, 1000);
                })
                .catch((err) => {
                    console.log('GetUserMedia: ' + err);
                });
            }
        
            initStream(imageConstraints);
        
        </script>
    </div>
  </body>
</html>